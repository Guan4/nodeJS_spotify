<!doctype html>
<html>
  <head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>G-Spotify</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
    <link rel="apple-touch-icon" href="img/item2.png">
    <style type="text/css">
      body{
        background: black;
        font-family: verdana;
        color: #fff;
        padding: 30px;
        overflow: hidden;
      }
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
      .cd_circle{
        position: absolute;
        top: 35%;
        left: 36%;
        background-color: black;
        border: gray solid 4px;
        border-radius: 50%;
        width: 50px;
        height: 50px;
      }
      .spin {
        -webkit-animation:spin 4s linear infinite;
        -moz-animation:spin 4s linear infinite;
        animation:spin 4s linear infinite;
      }
      #album_img{
        opacity: 0.8;
        border-radius: 50%;
        left: 71px;
        top: 68px;
        width: 300px;
        height: 300px;
      }
      .buttons img{
        width: 40px;
        margin-right: 10px;
        cursor: pointer;
      }

      .buttons img:hover{
        border-radius: 60%;
        background-color: #FFCD87;
      }

      @-moz-keyframes spin { 100% { -moz-transform: rotate(360deg); } }
      @-webkit-keyframes spin { 100% { -webkit-transform: rotate(360deg); } }
      @keyframes spin { 100% { -webkit-transform: rotate(360deg); transform:rotate(360deg); } }


      /*****************************volume slider css*****************************/
      .demo {
        display: none;
        position: absolute;
        top: 306px;
        right: 85px;
      }
      .ui-slider .ui-slider-handle {
        position: absolute;
        z-index: 2;
        width: 2em;
        height: 2em;
        cursor: default;
      }
      .ui-slider .ui-slider-range {
        position: absolute;
        z-index: 1;
        font-size: .7em;
        display: block;
        border: 0;
        background-position: 0 0;
      }

      #slider-vertical{
        height:199px;
        width: 32px;
        position: relative;
        background-color: #FBD3D1;
        border-radius: 5px;
        border: 14px solid #2E7743;

      }

      .ui-slider-vertical .ui-slider-handle {
        background: orange;
        width: 25px;
        height: 12px;
        border-bottom: 2px solid #6D403F;
        left: -.7em;
        margin-bottom: -.5em;
      }
      .ui-slider-vertical .ui-slider-range {
        left: 0;
        width: 100%;
      }

      /****************************volume slider css****************************/

      /****************************responsive css for screen size****************************/
      #pointer{
        width: 230px;
        left: 252px;
        top: 54px;
      }

      .artist{
        font-size: 12px;
        margin-top: 10px;
      }

      .leftDesign img{
        width: 400px;
      }

      @media screen and (max-width: 1199px) {
        .demo {
          display: none;
          position: absolute;
          top: 278px;
          right: 40px;
        }

        #slider-vertical{
          height: 176px;
          width: 30px;
          border: 13px solid #2E7743;
        }

        .leftDesign img{
          width: 350px;
        }

        #pointer{
          width: 180px;
          left: 243px;
          top: 52px;
        }

        #album_img{
          left: 63px;
          top: 63px;
          width: 263px;
          height: 263px;
        }

        #turnTable{
          width: 100% !important;
        }
      }

      @media screen and (max-width: 991px) {
        .container{
          width: 100% !important;
        }
        h4{
          font-size: 32px;
        }
        .artist{
          font-size: 24px;
        }
        .demo {
          display: none;
          position: absolute;
          top: 445px;
          right: 85px;
        }

        .ui-slider-vertical .ui-slider-handle {
          width: 37px;
          height: 18px;
          border-bottom: 5px solid #6D403F;
          left: -.9em;
          margin-bottom: -.5em;
        }

        .leftDesign{
          display: none;
        }

        #pointer{
          width: 318px;
          left: 511px;
          top: 95px;
        }

        #album_img{
          left: 127px;
          top: 126px;
          width: 510px;
          height: 510px;
        }

        #slider-vertical{
          height: 410px;
          width: 70px;
          border: 30px solid #2E7743;
        }

        .buttons img{
          width: 70px;
          margin-right: 35px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container" style="min-width: 750px;">
      <div class="row">
        <div class="col-lg-6 col-md-6 leftDesign" style="text-align: center;">
          <div id="alarmClock" style="margin-bottom: 20px; width: 400px; height: 200px;">
            <input type="time" id="alarmTime" style="color: #000;"/>
            <button onclick="setAlarm(this);" id="alarmButton">Set Alarm</button>

          </div>
          <!--<div id="emojis" style="margin-bottom: 20px;">-->
	          <!--<div class="block_outer" style="width: 400px; height: 200px; border: #999A9C solid 1px;">-->

	          <!--</div>-->
          <!--</div>-->
          <img class="bottomD" src="img/item1.png">
        </div>

        <div class="col-lg-6 col-md-6 basicInfo">
          <div id="login">
            <h1>This is an example of the Authorization Code flow</h1>
            <a href="/login" class="btn btn-primary">Log in with Spotify</a>
          </div>
          <div id="loggedin">
            <div id="user-profile">
            </div>
            <div id="player" style="margin-top: 10px;">
            </div>
            <div class="demo">
              <input type="hidden" id="amount"/>
              <div id="slider-vertical"></div>
            </div>
            <div class="buttons" style="text-align: center;">
              <img id="playPrevious" src="img/previous_w.png">
              <img id="playbtn" src="img/play_w.png">
              <img id="playNext" src="img/next_w.png">
            </div>

          </div>
        </div>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      <h4 style="display: inline-block;">{{greeting}}</h4>
      <h3 style="display: inline-block;">{{display_name}}</h3>
    </script>

    <script id="player-template" type="text/x-handlebars-template">
      <div style="position: relative;">
        <img id="turnTable" src="img/turnTable.png" style="width: 515px;">
        <img id="album_img" src="{{item.album.images.1.url}}" style="position: absolute;">
        <img id="pointer" src="img/pointer.png" style="position: absolute;">
        <!--<div class="cd_circle"></div>-->
      </div>
      <h4 style="margin-top: 20px;"><span>{{item.name}}</span><p class="artist">{{item.artists.0.name}}</p></h4>
      <div>

      </div>
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="touchPunch.js"></script>
    <script>
      var access_token;
		    function cookieExists(name) {
        var cks = document.cookie.split(';');
        for(i = 0; i < cks.length; i++)
          if (cks[i].split('=')[0].trim() == name) {
            return cks[i].split('=')[1];
          }
      }
      var cookie = cookieExists("spotify_auth_state");

      (function() {
        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var playerSource = document.getElementById('player-template').innerHTML,
            playerTemplate = Handlebars.compile(playerSource),
            playerPlaceholder = document.getElementById('player');

        $('.demo').show();

        var Greeting = {};

	      if(cookie){
		      $.ajax({
			      url: '/userLogin',
			      data: { cookie: cookie},
			      success: function(response) {
              if(response.result){
					      access_token = response.access_token;
					      var display_name = response.display_name;
	              Greeting['display_name'] = display_name;
					      // userProfilePlaceholder.innerHTML = userProfileTemplate({display_name: display_name});
					      $('#login').hide();
					      $('#loggedin').show();
              }else{
					      $('#login').show();
					      $('#loggedin').hide();
              }
			      }
		      });

		      var currentPlaySong = '';
		      var currentGreeting = '';



		      setInterval(function(){
			      if(access_token !== undefined){
			      	getPlayerInfo();
			      	getTime();
			      }
          }, 1000);

		      function getPlayerInfo(){
			      $.ajax({
				      url: '/getPlayerInfo',
				      data: { access_token: access_token},
				      success: function(response) {
					      var songName = response.item.name;
					      if(currentPlaySong !== songName){
						      currentPlaySong = songName;
						      playerPlaceholder.innerHTML = playerTemplate(response);
						      var image = response.item.album.images[1].url;
						      if(response.is_playing == false){
							      $('#playbtn').attr('data-mode','pause');
							      $('#playbtn').attr('src', 'img/play_w.png');
							      // $('#playbtn').html('<i class="fa fa-play" aria-hidden="true"></i>');
						      }else{
							      $('#playbtn').attr('data-mode','playing');
							      $('#playbtn').attr('src', 'img/pause_w.png');
							      // $('#playbtn').html('<i class="fa fa-pause" aria-hidden="true"></i>');
							      $('#album_img').addClass('spin');
						      }
					      }
				      }
			      });
		      }

		      function getTime(){
			      $.ajax({
				      url: '/getTime',
				      success: function(response) {
					      var greeting = response.greeting;
					      if(currentGreeting !== greeting){
						      currentGreeting = greeting;
						      Greeting['greeting'] = greeting;
						      userProfilePlaceholder.innerHTML = userProfileTemplate(Greeting);
					      }
				      }
			      });
		      }

	      }else {
		      // render initial screen
		      $('#login').show();
		      $('#loggedin').hide();
	      }

	      $('#playPrevious').on('click', function(){
		      console.log('previous');
		      $.ajax({
			      url: '/playPrevious',
			      data: { access_token: access_token},
			      success: function(response) {
				      console.log('spin2');
				      $('#album_img').addClass('spin');
			      }
		      });
	      });

	      $('#playNext').on('click', function(){
		      console.log('next');
		      $.ajax({
			      url: '/playNext',
			      data: { access_token: access_token},
			      success: function(response) {
				      console.log('spin3');
			      	$('#album_img').addClass('spin');
			      }
		      });
	      });

	      $('#playbtn').on('click', function(){
		      var mode = $(this).attr('data-mode');
		      if(mode == "playing"){
			      $(this).attr('data-mode','pause');
			      $.ajax({
				      url: '/pause',
				      data: { access_token: access_token},
				      success: function(response) {
					      console.log(response);
					      $('#playbtn').attr('src','img/play_w.png');
					      $('#album_img').removeClass('spin');
				      }
			      });
		      }else{
			      $(this).attr('data-mode','playing');
			      $.ajax({
				      url: '/play',
				      data: { access_token: access_token},
				      success: function(response) {
					      console.log(response);
					      $('#playbtn').attr('src', 'img/pause_w.png');
					      // $('#playbtn').html('<i class="fa fa-pause" aria-hidden="true"></i>');
					      console.log('spin4');
					      $('#album_img').addClass('spin');
				      }
			      });
		      }
	      });
      })();

      // set volume
      $("#slider-vertical").slider({
	      orientation: "vertical",
	      range: "min",
	      min: 0,
	      max: 100,
	      step: 5,
	      value: 45,
	      slide: function (event, ui) {
		      $("#amount").val(ui.value);
		      $.ajax({
			      url: '/volume',
			      data: { access_token: access_token, volume: ui.value},
			      success: function(response) {
				      // console.log('done set volume');
			      }
		      });
	      }
      });

      $("#amount").val($("#slider-vertical").slider("value"));


      function setAlarm(){
      	console.log('Alarm set!');
      	var alarm = document.getElementById('alarmTime').value;
	      var timeArr = alarm.split(":");
	      var setHour = timeArr[0];
	      var setMinute = timeArr[1];
	      var setHourToMin = setHour * 60;
	      var totalSetMin = setHourToMin + setMinute ;


	      //avoid token get expired very hour
	      var wakeToken = setInterval(function(){
		      //play music at 0 volume;
		      initAlarm(0,true);
	      }, 300000); //every 5 minute

	      //check if it is time to ring
	      var checkRing = setInterval(function(){
		      var today = new Date();
		      var hour = (today.getHours() < 10 ? '0' : '') + today.getHours();
		      var minutes = (today.getMinutes() < 10 ? '0' : '') + today.getMinutes();

	        if(setHour == hour && setMinute == minutes){
		        console.log('it is time to ring!!!');
		        initAlarm(60,false);
		        clearInterval(checkRing);
		        clearInterval(wakeToken);
	        }
        }, 1000); //every second

      }

      function initAlarm(volume,wakeToken){
      	console.log('wakeToken or not? '+wakeToken);
	      $.ajax({
		      url: '/volume',
		      data: { access_token: access_token, volume: volume},
		      success: function(response) {
			      console.log('set volume to '+ volume);
		      }
	      });
	      $.ajax({
		      url: '/play',
		      data: { access_token: access_token},
		      success: function(response) {
			      console.log("play music");
			      $('#playbtn').attr('src', 'img/pause_w.png');
			      // $('#playbtn').html('<i class="fa fa-pause" aria-hidden="true"></i>');
			      $('#album_img').addClass('spin');
		      }
	      });

	      if(wakeToken){
		      setTimeout(function(){
			      $.ajax({
				      url: '/pause',
				      data: { access_token: access_token},
				      success: function(response) {
					      console.log("wakeToken pause music");
					      $('#playbtn').attr('src','img/play_w.png');
					      $('#album_img').removeClass('spin');
				      }
			      });
		      },3000)
        }
      }

    </script>
  </body>
</html>

