<!doctype html>
<html>
  <head>
    <title>G-Spotify</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
    <style type="text/css">
      body{
        background: black;
        font-family: verdana;
        color: #fff;
        padding: 30px;
      }
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
      .cd_circle{
        position: absolute;
        top: 35%;
        left: 36%;
        background-color: black;
        border: gray solid 4px;
        border-radius: 50%;
        width: 50px;
        height: 50px;
      }
      .spin {
        -webkit-animation:spin 4s linear infinite;
        -moz-animation:spin 4s linear infinite;
        animation:spin 4s linear infinite;
      }
      #album_img{
        opacity: 0.8;
        border-radius: 50%;
        width: 300px;
        height: 300px;
      }
      .buttons img{
        width: 40px;
        margin-right: 10px;
        cursor: pointer;
      }

      .buttons img:hover{
        border-radius: 60%;
        background-color: #FFCD87;
      }

      @-moz-keyframes spin { 100% { -moz-transform: rotate(360deg); } }
      @-webkit-keyframes spin { 100% { -webkit-transform: rotate(360deg); } }
      @keyframes spin { 100% { -webkit-transform: rotate(360deg); transform:rotate(360deg); } }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="row">
        <div class="col-lg-6 leftDesign" style="text-align: center;">
          <img class="topD" src="img/notes_w.png" style="width: 400px;">
          <img class="bottomD" src="img/item1.png" style="height: 400px;">
        </div>

        <div class="col-lg-6 basicInfo">
          <div id="login">
            <h1>This is an example of the Authorization Code flow</h1>
            <a href="/login" class="btn btn-primary">Log in with Spotify</a>
          </div>
          <div id="loggedin">
            <div id="user-profile">
            </div>
            <div id="player">
            </div>
            <div class="buttons" style="text-align: center;">
              <img id="playPrevious" src="img/previous_w.png">
              <img id="playbtn" src="img/play_w.png">
              <img id="playNext" src="img/next_w.png">
            </div>
          </div>
        </div>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      <h4 style="display: inline-block;">{{greeting}}</h4>
      <h3 style="display: inline-block;">{{display_name}}</h3>
    </script>

    <script id="player-template" type="text/x-handlebars-template">
      <h4 style="display: inline-block;">Now listening to: <span>{{item.name}}</span></h4>
      <div style="position: relative;">
        <img id="turnTable" src="img/turnTable.png" style="width: 515px;">
        <img id="album_img" src="{{item.album.images.1.url}}" style="position: absolute; left: 71px; top: 68px;">
        <img id="pointer" src="img/pointer.png" style="width: 230px; position: absolute; left: 252px; top: 54px;">
        <!--<div class="cd_circle"></div>-->
      </div>
      <br>
      <div>
        <p style="text-align: right;">Artist: {{item.artists.0.name}}</p>
      </div>
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
	    var access_token;
		    function cookieExists(name) {
        var cks = document.cookie.split(';');
        for(i = 0; i < cks.length; i++)
          if (cks[i].split('=')[0].trim() == name) {
            return cks[i].split('=')[1];
          }
      }
      var cookie = cookieExists("spotify_auth_state");
      (function() {
        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var playerSource = document.getElementById('player-template').innerHTML,
            playerTemplate = Handlebars.compile(playerSource),
            playerPlaceholder = document.getElementById('player');

        var Greeting = {};

	      if(cookie){
		      $.ajax({
			      url: '/userLogin',
			      data: { cookie: cookie},
			      success: function(response) {
              if(response.result){
					      access_token = response.access_token;
					      var display_name = response.display_name;
	              Greeting['display_name'] = display_name;
					      // userProfilePlaceholder.innerHTML = userProfileTemplate({display_name: display_name});
					      $('#login').hide();
					      $('#loggedin').show();
              }else{
					      $('#login').show();
					      $('#loggedin').hide();
              }
			      }
		      });

		      var currentPlaySong = '';
		      var currentGreeting = '';



		      setInterval(function(){
			      if(access_token !== undefined){
			      	getPlayerInfo();
			      	getTime();
			      }
          }, 1000);

		      function getPlayerInfo(){
			      $.ajax({
				      url: '/getPlayerInfo',
				      data: { access_token: access_token},
				      success: function(response) {
					      var songName = response.item.name;
					      if(currentPlaySong !== songName){
						      currentPlaySong = songName;
						      playerPlaceholder.innerHTML = playerTemplate(response);
						      var image = response.item.album.images[1].url;
						      if(response.is_playing == false){
							      $('#playbtn').attr('data-mode','pause');
							      $('#playbtn').attr('src', 'img/play_w.png');
							      // $('#playbtn').html('<i class="fa fa-play" aria-hidden="true"></i>');
						      }else{
							      $('#playbtn').attr('data-mode','playing');
							      $('#playbtn').attr('src', 'img/pause_w.png');
							      // $('#playbtn').html('<i class="fa fa-pause" aria-hidden="true"></i>');
							      $('#album_img').addClass('spin');
						      }
					      }
				      }
			      });
		      }

		      function getTime(){
			      $.ajax({
				      url: '/getTime',
				      success: function(response) {
					      var greeting = response.greeting;
					      if(currentGreeting !== greeting){
						      currentGreeting = greeting;
						      Greeting['greeting'] = greeting;
						      userProfilePlaceholder.innerHTML = userProfileTemplate(Greeting);
					      }
				      }
			      });
		      }

	      }else {
		      // render initial screen
		      $('#login').show();
		      $('#loggedin').hide();
	      }

	      $('#playPrevious').on('click', function(){
		      console.log('previous');
		      $.ajax({
			      url: '/playPrevious',
			      data: { access_token: access_token},
			      success: function(response) {
				      console.log('spin2');
				      $('#album_img').addClass('spin');
			      }
		      });
	      });

	      $('#playNext').on('click', function(){
		      console.log('next');
		      $.ajax({
			      url: '/playNext',
			      data: { access_token: access_token},
			      success: function(response) {
				      console.log('spin3');
			      	$('#album_img').addClass('spin');
			      }
		      });
	      });

	      $('#playbtn').on('click', function(){
		      var mode = $(this).attr('data-mode');
		      if(mode == "playing"){
			      $(this).attr('data-mode','pause');
			      $.ajax({
				      url: '/pause',
				      data: { access_token: access_token},
				      success: function(response) {
					      console.log(response);
					      $('#playbtn').attr('src','img/play_w.png');
					      $('#album_img').removeClass('spin');
				      }
			      });
		      }else{
			      $(this).attr('data-mode','playing');
			      $.ajax({
				      url: '/play',
				      data: { access_token: access_token},
				      success: function(response) {
					      console.log(response);
					      $('#playbtn').attr('src', 'img/pause_w.png');
					      // $('#playbtn').html('<i class="fa fa-pause" aria-hidden="true"></i>');
					      console.log('spin4');
					      $('#album_img').addClass('spin');
				      }
			      });
		      }
	      });
      })();
    </script>
  </body>
</html>

