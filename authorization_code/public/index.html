<!doctype html>
<html>
  <head>
    <title>G-Spotify</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
    <style type="text/css">
      body{
        background: skyblue;
        font-family: verdana;
        color: #fff;
        padding: 30px;
      }
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="login">
        <h1>This is an example of the Authorization Code flow</h1>
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
      </div>
      <div id="loggedin">
        <div id="user-profile">
        </div>
         <div id="player">
        </div>
        <div class="buttons">
           <button class="btn btn-default" id="playPrevious"><i class="fa fa-step-backward" aria-hidden="true"></i></button>
           <button class="btn btn-default" data-mode="playing" id="playbtn"><i class="fa fa-pause" aria-hidden="true"></i></button>
           <button class="btn btn-default" id="playNext"><i class="fa fa-step-forward" aria-hidden="true"></i></button>
        </div>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      <h1>Hello {{display_name}}</h1>
    </script>

    <script id="player-template" type="text/x-handlebars-template">
      <h2>Now you are listening to</h2>
      <div>
        <img id="album_img" src="{{item.album.images.1.url}}">
        <div>
          <p>{{item.name}}</p>
          <p>{{item.artists.0.name}}</p>
        </div>
      </div>
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
	    var access_token;
		    function cookieExists(name) {
        var cks = document.cookie.split(';');
        for(i = 0; i < cks.length; i++)
          if (cks[i].split('=')[0].trim() == name) {
            return cks[i].split('=')[1];
          }
      }
      var cookie = cookieExists("spotify_auth_state");
      (function() {
        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var playerSource = document.getElementById('player-template').innerHTML,
            playerTemplate = Handlebars.compile(playerSource),
            playerPlaceholder = document.getElementById('player');

	      if(cookie){
		      $.ajax({
			      url: '/userLogin',
			      data: { cookie: cookie},
			      success: function(response) {
			      	console.log(response);
              if(response.result){
					      access_token = response.access_token;
					      var display_name = response.display_name;
					      userProfilePlaceholder.innerHTML = userProfileTemplate({display_name: display_name});
					      $('#login').hide();
					      $('#loggedin').show();
              }else{
					      $('#login').show();
					      $('#loggedin').hide();
              }
			      }
		      });

		      var currentPlaySong = '';



		      setInterval(function(){
			      if(access_token !== undefined){
			      	getPlayerInfo();
			      }
          }, 1000);

		      function getPlayerInfo(){
			      $.ajax({
				      url: '/getPlayerInfo',
				      data: { access_token: access_token},
				      success: function(response) {
					      var songName = response.item.name;
					      if(currentPlaySong !== songName){
						      currentPlaySong = songName;
						      playerPlaceholder.innerHTML = playerTemplate(response);
						      var image = response.item.album.images[1].url;
						      if(response.is_playing == false){
							      $('#playbtn').attr('data-mode','pause');
							      $('#playbtn').html('<i class="fa fa-play" aria-hidden="true"></i>');
						      }else{
							      $('#playbtn').attr('data-mode','playing');
							      $('#playbtn').html('<i class="fa fa-pause" aria-hidden="true"></i>');
						      }
					      }
				      }
			      });
		      }

	      }else {
		      // render initial screen
		      $('#login').show();
		      $('#loggedin').hide();
	      }

	      $('#playPrevious').on('click', function(){
		      console.log('previous');
		      $.ajax({
			      url: '/playPrevious',
			      data: { access_token: access_token},
			      success: function(response) {
			      }
		      });
	      });

	      $('#playNext').on('click', function(){
		      console.log('next');
		      $.ajax({
			      url: '/playNext',
			      data: { access_token: access_token},
			      success: function(response) {
			      }
		      });
	      });

	      $('#playbtn').on('click', function(){
		      var mode = $(this).attr('data-mode');
		      if(mode == "playing"){
			      $(this).attr('data-mode','pause');
			      $.ajax({
				      url: '/pause',
				      data: { access_token: access_token},
				      success: function(response) {
					      console.log(response);
					      $('#playbtn').html('<i class="fa fa-play" aria-hidden="true"></i>');
				      }
			      });
		      }else{
			      $(this).attr('data-mode','playing');
			      $.ajax({
				      url: '/play',
				      data: { access_token: access_token},
				      success: function(response) {
					      console.log(response);
					      $('#playbtn').html('<i class="fa fa-pause" aria-hidden="true"></i>');
				      }
			      });
		      }
	      });
      })();
    </script>
  </body>
</html>

